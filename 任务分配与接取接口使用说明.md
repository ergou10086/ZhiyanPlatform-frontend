# 任务分配与接取接口使用说明

## 接口概述

前端已经配置好了任务分配和接取的API接口，可以直接在Vue组件中使用。

## 1. 分配任务接口

### 后端接口
- **URL**: `PUT /zhiyan/api/projects/tasks/{taskId}/assign`
- **说明**: 将任务分配给项目成员（可以是一个或多个成员）
- **权限**: 需要是项目成员

### 前端调用方法

```javascript
import { taskAPI } from '@/api/task'

// 分配任务给指定用户
async function assignTaskToUsers(taskId, userIds) {
  try {
    const response = await taskAPI.assignTask(taskId, userIds)
    
    if (response.code === 200) {
      console.log('任务分配成功:', response.data)
      // 更新UI或显示成功提示
      this.$message.success(response.msg || '任务已分配')
      return response.data
    } else {
      console.error('任务分配失败:', response.msg)
      this.$message.error(response.msg || '分配失败')
      return null
    }
  } catch (error) {
    console.error('分配任务异常:', error)
    this.$message.error('操作失败，请重试')
    return null
  }
}
```

### 使用示例

```javascript
// 示例1: 分配任务给单个用户
await taskAPI.assignTask(123, [456])

// 示例2: 分配任务给多个用户
await taskAPI.assignTask(123, [456, 789, 101])

// 示例3: 清空任务执行者（分配给空列表）
await taskAPI.assignTask(123, [])
```

### 参数说明
- `taskId` (Number): 任务ID
- `assigneeIds` (Array<Number>): 执行者ID列表
  - 可以是空数组（清空执行者）
  - 可以包含一个或多个用户ID
  - 所有用户必须是项目成员

## 2. 接取任务接口

### 后端接口
- **URL**: `POST /zhiyan/api/projects/tasks/{taskId}/claim`
- **说明**: 当前用户主动接取任务，将自己添加到任务执行者列表
- **权限**: 需要是项目成员
- **特性**: 
  - 接取后会自动将用户添加到执行者列表
  - 如果任务状态是TODO，会自动变更为IN_PROGRESS
  - 如果已经是执行者，会返回错误提示

### 前端调用方法

```javascript
import { taskAPI } from '@/api/task'

// 接取任务
async function claimTaskById(taskId) {
  try {
    const response = await taskAPI.claimTask(taskId)
    
    if (response.code === 200) {
      console.log('任务接取成功:', response.data)
      // 更新UI或显示成功提示
      this.$message.success(response.msg || '任务接取成功')
      return response.data
    } else {
      console.error('任务接取失败:', response.msg)
      this.$message.error(response.msg || '接取失败')
      return null
    }
  } catch (error) {
    console.error('接取任务异常:', error)
    this.$message.error('操作失败，请重试')
    return null
  }
}
```

### 使用示例

```javascript
// 示例：当前用户接取任务
await taskAPI.claimTask(123)
```

### 参数说明
- `taskId` (Number): 任务ID

## 3. 在Vue组件中的完整使用示例

```vue
<template>
  <div class="task-actions">
    <!-- 任务卡片 -->
    <div class="task-card">
      <h3>{{ task.title }}</h3>
      <p>{{ task.description }}</p>
      
      <!-- 执行者列表 -->
      <div class="assignees">
        <span v-for="user in assignees" :key="user.id">
          {{ user.name }}
        </span>
      </div>
      
      <!-- 操作按钮 -->
      <div class="actions">
        <!-- 接取任务按钮 -->
        <button 
          @click="handleClaimTask" 
          :disabled="isAssignee"
          class="btn-claim">
          {{ isAssignee ? '已接取' : '接取任务' }}
        </button>
        
        <!-- 分配任务按钮（假设有权限） -->
        <button 
          @click="showAssignDialog" 
          class="btn-assign">
          分配任务
        </button>
      </div>
    </div>
    
    <!-- 分配任务对话框 -->
    <el-dialog 
      title="分配任务" 
      :visible.sync="assignDialogVisible"
      width="500px">
      <el-select 
        v-model="selectedUserIds" 
        multiple 
        placeholder="请选择执行者">
        <el-option
          v-for="member in projectMembers"
          :key="member.id"
          :label="member.name"
          :value="member.id">
        </el-option>
      </el-select>
      
      <span slot="footer">
        <el-button @click="assignDialogVisible = false">取消</el-button>
        <el-button type="primary" @click="handleAssignTask">确定</el-button>
      </span>
    </el-dialog>
  </div>
</template>

<script>
import { taskAPI } from '@/api/task'

export default {
  name: 'TaskCard',
  props: {
    task: {
      type: Object,
      required: true
    },
    projectMembers: {
      type: Array,
      default: () => []
    }
  },
  data() {
    return {
      assignDialogVisible: false,
      selectedUserIds: [],
      assignees: []
    }
  },
  computed: {
    // 判断当前用户是否已经是执行者
    isAssignee() {
      const currentUserId = this.$store.state.user.id
      return this.assignees.some(user => user.id === currentUserId)
    }
  },
  methods: {
    // 接取任务
    async handleClaimTask() {
      try {
        const result = await taskAPI.claimTask(this.task.id)
        
        if (result.code === 200) {
          this.$message.success('任务接取成功')
          // 刷新任务数据
          await this.refreshTask()
        }
      } catch (error) {
        console.error('接取任务失败:', error)
      }
    },
    
    // 显示分配对话框
    showAssignDialog() {
      this.selectedUserIds = this.assignees.map(user => user.id)
      this.assignDialogVisible = true
    },
    
    // 分配任务
    async handleAssignTask() {
      try {
        const result = await taskAPI.assignTask(
          this.task.id, 
          this.selectedUserIds
        )
        
        if (result.code === 200) {
          this.$message.success('任务分配成功')
          this.assignDialogVisible = false
          // 刷新任务数据
          await this.refreshTask()
        }
      } catch (error) {
        console.error('分配任务失败:', error)
      }
    },
    
    // 刷新任务数据
    async refreshTask() {
      try {
        const result = await taskAPI.getTaskDetail(this.task.id)
        if (result.code === 200) {
          // 更新任务数据
          this.$emit('task-updated', result.data)
          this.assignees = result.data.assignees || []
        }
      } catch (error) {
        console.error('刷新任务失败:', error)
      }
    }
  },
  mounted() {
    this.assignees = this.task.assignees || []
  }
}
</script>
```

## 4. 后端返回数据格式

### 成功响应
```json
{
  "code": 200,
  "msg": "任务已分配" 或 "任务接取成功",
  "data": {
    "id": 123,
    "projectId": 456,
    "title": "任务标题",
    "description": "任务描述",
    "status": "IN_PROGRESS",
    "priority": "HIGH",
    "assigneeId": "[789, 101]",  // JSON字符串格式的执行者ID列表
    "creatorId": 111,
    "dueDate": "2025-12-31",
    "worktime": 8.5,
    "createdAt": "2025-10-31T10:00:00",
    "updatedAt": "2025-10-31T11:00:00"
  }
}
```

### 错误响应
```json
{
  "code": 400,
  "msg": "任务不存在" 或 "只有项目成员才能接取任务" 或 "您已经是该任务的执行者",
  "data": null
}
```

## 5. 业务逻辑说明

### 分配任务（assignTask）
1. 只有项目成员可以分配任务
2. 可以分配给一个或多个项目成员
3. 被分配的用户必须都是项目成员
4. 可以传空数组来清空执行者列表
5. 会覆盖原有的执行者列表

### 接取任务（claimTask）
1. 只有项目成员可以接取任务
2. 接取后会将当前用户添加到执行者列表（不会覆盖原有执行者）
3. 如果已经是执行者，会返回错误提示
4. 如果任务状态是TODO，接取后会自动变为IN_PROGRESS
5. 适用于任务无人认领，成员主动接取的场景

## 6. 注意事项

1. **权限控制**: 两个接口都需要用户登录且是项目成员
2. **并发安全**: 后端使用事务保证数据一致性
3. **重复检测**: 接取任务时会检查是否已经是执行者
4. **状态变更**: 接取任务可能会自动变更任务状态
5. **错误处理**: 前端需要处理各种错误情况并给用户友好提示

## 7. 相关接口

除了分配和接取任务，还可以使用以下相关接口：

```javascript
// 获取任务详情
await taskAPI.getTaskDetail(taskId)

// 更新任务状态
await taskAPI.updateTaskStatus(taskId, 'IN_PROGRESS')

// 获取我的任务
await taskAPI.getMyAssignedTasks(page, size)

// 获取项目任务看板
await taskAPI.getTaskBoard(projectId)
```

---

**最后更新时间**: 2025-10-31


