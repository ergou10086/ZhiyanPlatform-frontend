<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wiki API æµ‹è¯•å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 14px;
    }
    
    .content {
      padding: 30px;
    }
    
    .test-section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f9fafb;
      border-radius: 12px;
      border-left: 4px solid #667eea;
    }
    
    .test-section h3 {
      margin-bottom: 15px;
      color: #1f2937;
      font-size: 18px;
    }
    
    .input-group {
      margin: 15px 0;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 8px;
      color: #4b5563;
      font-weight: 500;
      font-size: 14px;
    }
    
    .input-group input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    
    .input-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    
    button {
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button.secondary {
      background: #6b7280;
    }
    
    button.danger {
      background: #ef4444;
    }
    
    #result {
      margin-top: 20px;
      padding: 20px;
      background: #1f2937;
      color: #f9fafb;
      border-radius: 12px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .success {
      color: #10b981;
      font-weight: 600;
    }
    
    .error {
      color: #ef4444;
      font-weight: 600;
    }
    
    .info {
      color: #3b82f6;
    }
    
    .warning {
      color: #f59e0b;
    }
    
    .timestamp {
      color: #9ca3af;
      font-size: 11px;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin: 5px 5px 5px 0;
    }
    
    .status-badge.success {
      background: #d1fae5;
      color: #065f46;
    }
    
    .status-badge.error {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .status-badge.warning {
      background: #fef3c7;
      color: #92400e;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ§ª Wiki API æµ‹è¯•å·¥å…·</h1>
      <p>æµ‹è¯• Wiki æœåŠ¡ï¼ˆ8234ç«¯å£ï¼‰çš„å‰åç«¯è¿æ¥</p>
    </div>
    
    <div class="content">
      <!-- çŠ¶æ€æ£€æŸ¥ -->
      <div class="test-section">
        <h3>ğŸ“Š ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h3>
        <div class="button-group">
          <button onclick="checkToken()">æ£€æŸ¥Token</button>
          <button onclick="checkProxy()">æ£€æŸ¥ä»£ç†é…ç½®</button>
          <button onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
          <button class="secondary" onclick="clearResult()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
      </div>
      
      <!-- APIæµ‹è¯• -->
      <div class="test-section">
        <h3>ğŸ”§ Wiki API æµ‹è¯•</h3>
        <div class="input-group">
          <label>é¡¹ç›®ID:</label>
          <input type="number" id="projectId" value="1" placeholder="è¾“å…¥é¡¹ç›®ID"/>
        </div>
        <div class="button-group">
          <button onclick="testGetTree()">è·å–Wikiæ ‘</button>
          <button onclick="testGetStatistics()">è·å–ç»Ÿè®¡ä¿¡æ¯</button>
          <button onclick="testCreatePage()">åˆ›å»ºæµ‹è¯•é¡µé¢</button>
          <button class="danger" onclick="testDeletePage()">åˆ é™¤æµ‹è¯•é¡µé¢</button>
        </div>
      </div>
      
      <!-- ç»“æœè¾“å‡º -->
      <div class="test-section">
        <h3>ğŸ“ æµ‹è¯•ç»“æœ</h3>
        <div id="result">ç­‰å¾…æµ‹è¯•...</div>
      </div>
    </div>
  </div>

  <script>
    const result = document.getElementById('result');
    let lastCreatedPageId = null;
    
    function getTimestamp() {
      return new Date().toLocaleTimeString('zh-CN', { hour12: false });
    }
    
    function log(message, type = 'info') {
      const colors = {
        success: 'success',
        error: 'error',
        info: 'info',
        warning: 'warning'
      };
      
      const timestamp = `<span class="timestamp">[${getTimestamp()}]</span>`;
      const content = `<span class="${colors[type]}">${message}</span>`;
      result.innerHTML += `${timestamp} ${content}\n`;
      result.scrollTop = result.scrollHeight;
      console.log(`[${getTimestamp()}] ${message}`);
    }
    
    function logBadge(status, message) {
      result.innerHTML += `<span class="status-badge ${status}">${message}</span>\n`;
      result.scrollTop = result.scrollHeight;
    }
    
    function clearResult() {
      result.innerHTML = 'æ—¥å¿—å·²æ¸…ç©ºï¼Œç­‰å¾…æ–°çš„æµ‹è¯•...\n';
    }
    
    function getToken() {
      return localStorage.getItem('access_token');
    }
    
    function checkToken() {
      clearResult();
      log('ğŸ” æ£€æŸ¥TokençŠ¶æ€...', 'info');
      
      const token = getToken();
      if (token) {
        log(`âœ… Tokenå­˜åœ¨: ${token.substring(0, 30)}...`, 'success');
        logBadge('success', 'Tokenæœ‰æ•ˆ');
        
        // è§£æJWT tokenï¼ˆå¦‚æœæ˜¯æ ‡å‡†æ ¼å¼ï¼‰
        try {
          const payload = JSON.parse(atob(token.split('.')[1]));
          log(`Tokenä¿¡æ¯:`, 'info');
          log(JSON.stringify(payload, null, 2), 'info');
        } catch (e) {
          log('Tokenä¸æ˜¯æ ‡å‡†JWTæ ¼å¼', 'warning');
        }
      } else {
        log('âŒ æœªæ‰¾åˆ°Tokenï¼è¯·å…ˆç™»å½•ï¼', 'error');
        logBadge('error', 'éœ€è¦ç™»å½•');
        log('æç¤º: è®¿é—® http://localhost:8001/login è¿›è¡Œç™»å½•', 'warning');
      }
    }
    
    function checkProxy() {
      clearResult();
      log('ğŸ” æ£€æŸ¥ä»£ç†é…ç½®...', 'info');
      log('å‰ç«¯æœåŠ¡: http://localhost:8001', 'info');
      log('WikiæœåŠ¡:  http://localhost:8234', 'info');
      log('ä»£ç†è§„åˆ™:  /api/wiki/* â†’ http://localhost:8234/api/wiki/*', 'info');
      log('', 'info');
      log('âš ï¸ å¦‚æœä¿®æ”¹äº† vue.config.jsï¼Œå¿…é¡»é‡å¯å‰ç«¯æœåŠ¡ï¼', 'warning');
      log('é‡å¯å‘½ä»¤:', 'info');
      log('  1. åœ¨å‰ç«¯ç»ˆç«¯æŒ‰ Ctrl+C åœæ­¢æœåŠ¡', 'info');
      log('  2. è¿è¡Œ: npm run serve', 'info');
    }
    
    async function testConnection() {
      clearResult();
      log('ğŸ”Œ æµ‹è¯•WikiæœåŠ¡è¿æ¥...', 'info');
      
      const token = getToken();
      if (!token) {
        log('âŒ æœªæ‰¾åˆ°Tokenï¼Œæ— æ³•æµ‹è¯•è¿æ¥ï¼', 'error');
        logBadge('error', 'éœ€è¦ç™»å½•');
        return;
      }
      
      log('å‘é€è¯·æ±‚åˆ°: /api/wiki/projects/1/tree', 'info');
      
      try {
        const startTime = Date.now();
        const response = await fetch('/api/wiki/projects/1/tree', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        const endTime = Date.now();
        const duration = endTime - startTime;
        
        log(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, 
            response.status === 200 ? 'success' : 'error');
        log(`å“åº”æ—¶é—´: ${duration}ms`, 'info');
        log(`Content-Type: ${response.headers.get('content-type')}`, 'info');
        
        const contentType = response.headers.get('content-type');
        
        if (contentType && contentType.includes('text/html')) {
          log('', 'error');
          log('âŒâŒâŒ ä¸¥é‡é”™è¯¯ï¼šè¿”å›äº†HTMLé¡µé¢ï¼âŒâŒâŒ', 'error');
          log('', 'error');
          log('åŸå› åˆ†æ:', 'error');
          log('  1. Vueä»£ç†é…ç½®æœªç”Ÿæ•ˆ', 'error');
          log('  2. è¯·æ±‚æ²¡æœ‰è½¬å‘åˆ° 8234 ç«¯å£', 'error');
          log('  3. å‰ç«¯æœåŠ¡éœ€è¦é‡å¯', 'error');
          log('', 'error');
          log('è§£å†³æ–¹æ¡ˆ:', 'warning');
          log('  1. åœæ­¢å‰ç«¯æœåŠ¡ï¼ˆCtrl+Cï¼‰', 'warning');
          log('  2. é‡æ–°è¿è¡Œ: npm run serve', 'warning');
          log('  3. ç­‰å¾…ç¼–è¯‘å®Œæˆåé‡è¯•', 'warning');
          logBadge('error', 'ä»£ç†æœªç”Ÿæ•ˆ - éœ€è¦é‡å¯');
          return;
        }
        
        const data = await response.json();
        
        if (data.code === 200) {
          log('', 'success');
          log('âœ…âœ…âœ… è¿æ¥æˆåŠŸï¼WikiæœåŠ¡æ­£å¸¸è¿è¡Œï¼âœ…âœ…âœ…', 'success');
          logBadge('success', 'æœåŠ¡æ­£å¸¸');
          log('', 'success');
          log('è¿”å›æ•°æ®:', 'info');
          log(JSON.stringify(data, null, 2), 'info');
        } else {
          log(`âš ï¸ æœåŠ¡è¿”å›é”™è¯¯: ${data.msg || 'æœªçŸ¥é”™è¯¯'}`, 'warning');
          logBadge('warning', `é”™è¯¯ç : ${data.code}`);
          log(JSON.stringify(data, null, 2), 'info');
        }
      } catch (error) {
        log('', 'error');
        log(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
        logBadge('error', 'è¿æ¥å¤±è´¥');
        log('', 'error');
        log('å¯èƒ½çš„åŸå› :', 'error');
        log('  1. WikiæœåŠ¡ï¼ˆ8234ç«¯å£ï¼‰æœªå¯åŠ¨', 'error');
        log('  2. ç½‘ç»œè¿æ¥é—®é¢˜', 'error');
        log('  3. ä»£ç†é…ç½®é”™è¯¯', 'error');
      }
    }
    
    async function testGetTree() {
      clearResult();
      const projectId = document.getElementById('projectId').value;
      log(`ğŸ“‚ è·å–é¡¹ç›® ${projectId} çš„Wikiæ ‘...`, 'info');
      
      const token = getToken();
      if (!token) {
        log('âŒ æœªæ‰¾åˆ°Tokenï¼', 'error');
        return;
      }
      
      try {
        const response = await fetch(`/api/wiki/projects/${projectId}/tree`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (data.code === 200) {
          log('âœ… è·å–æˆåŠŸï¼', 'success');
          log(`é¡µé¢æ•°é‡: ${data.data ? data.data.length : 0}`, 'info');
          logBadge('success', `æ‰¾åˆ°${data.data.length}ä¸ªé¡µé¢`);
          log('', 'info');
          log('Wikiæ ‘ç»“æ„:', 'info');
          log(JSON.stringify(data.data, null, 2), 'info');
        } else {
          log(`âŒ è·å–å¤±è´¥: ${data.msg}`, 'error');
          logBadge('error', `é”™è¯¯ç : ${data.code}`);
        }
      } catch (error) {
        log(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
      }
    }
    
    async function testGetStatistics() {
      clearResult();
      const projectId = document.getElementById('projectId').value;
      log(`ğŸ“Š è·å–é¡¹ç›® ${projectId} çš„ç»Ÿè®¡ä¿¡æ¯...`, 'info');
      
      const token = getToken();
      if (!token) {
        log('âŒ æœªæ‰¾åˆ°Tokenï¼', 'error');
        return;
      }
      
      try {
        const response = await fetch(`/api/wiki/projects/${projectId}/statistics`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (data.code === 200) {
          log('âœ… è·å–æˆåŠŸï¼', 'success');
          log('', 'info');
          log('ç»Ÿè®¡ä¿¡æ¯:', 'info');
          log(`  æ€»é¡µé¢æ•°: ${data.data.totalPages || 0}`, 'info');
          log(`  æ–‡æ¡£æ•°: ${data.data.documentCount || 0}`, 'info');
          log(`  ç›®å½•æ•°: ${data.data.directoryCount || 0}`, 'info');
          log(`  é™„ä»¶æ•°: ${data.data.totalAttachments || 0}`, 'info');
          logBadge('success', `${data.data.totalPages}ä¸ªé¡µé¢`);
        } else {
          log(`âŒ è·å–å¤±è´¥: ${data.msg}`, 'error');
        }
      } catch (error) {
        log(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
      }
    }
    
    async function testCreatePage() {
      clearResult();
      const projectId = document.getElementById('projectId').value;
      log(`ğŸ“ åˆ›å»ºæµ‹è¯•é¡µé¢...`, 'info');
      
      const token = getToken();
      if (!token) {
        log('âŒ æœªæ‰¾åˆ°Tokenï¼', 'error');
        return;
      }
      
      const pageData = {
        projectId: parseInt(projectId),
        title: 'è‡ªåŠ¨æµ‹è¯•é¡µé¢ - ' + new Date().toLocaleString('zh-CN'),
        pageType: 'DOCUMENT',
        content: `# è‡ªåŠ¨æµ‹è¯•é¡µé¢

è¿™æ˜¯ä¸€ä¸ªç”±æµ‹è¯•å·¥å…·è‡ªåŠ¨åˆ›å»ºçš„é¡µé¢ã€‚

## æµ‹è¯•ä¿¡æ¯
- åˆ›å»ºæ—¶é—´: ${new Date().toLocaleString('zh-CN')}
- é¡¹ç›®ID: ${projectId}

## æµ‹è¯•å†…å®¹
è¿™ä¸ªé¡µé¢å¯ä»¥å®‰å…¨åˆ é™¤ã€‚`,
        changeDescription: 'è‡ªåŠ¨æµ‹è¯•åˆ›å»º'
      };
      
      log('è¯·æ±‚æ•°æ®:', 'info');
      log(JSON.stringify(pageData, null, 2), 'info');
      log('', 'info');
      
      try {
        const response = await fetch('/api/wiki/pages', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(pageData)
        });
        
        const data = await response.json();
        
        if (data.code === 200) {
          lastCreatedPageId = data.data.id;
          log('âœ… åˆ›å»ºæˆåŠŸï¼', 'success');
          log(`é¡µé¢ID: ${lastCreatedPageId}`, 'success');
          logBadge('success', `åˆ›å»ºæˆåŠŸ ID:${lastCreatedPageId}`);
          log('', 'info');
          log('è¿”å›æ•°æ®:', 'info');
          log(JSON.stringify(data.data, null, 2), 'info');
          log('', 'warning');
          log('ğŸ’¡ æç¤º: å¯ä»¥ä½¿ç”¨"åˆ é™¤æµ‹è¯•é¡µé¢"æŒ‰é’®æ¸…ç†è¿™ä¸ªé¡µé¢', 'warning');
        } else {
          log(`âŒ åˆ›å»ºå¤±è´¥: ${data.msg}`, 'error');
          logBadge('error', `é”™è¯¯ç : ${data.code}`);
          log(JSON.stringify(data, null, 2), 'info');
        }
      } catch (error) {
        log(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
      }
    }
    
    async function testDeletePage() {
      if (!lastCreatedPageId) {
        clearResult();
        log('âš ï¸ æ²¡æœ‰å¯åˆ é™¤çš„æµ‹è¯•é¡µé¢', 'warning');
        log('è¯·å…ˆè¿è¡Œ"åˆ›å»ºæµ‹è¯•é¡µé¢"', 'warning');
        return;
      }
      
      if (!confirm(`ç¡®å®šè¦åˆ é™¤æµ‹è¯•é¡µé¢ ID:${lastCreatedPageId} å—ï¼Ÿ`)) {
        return;
      }
      
      clearResult();
      log(`ğŸ—‘ï¸ åˆ é™¤æµ‹è¯•é¡µé¢ ID:${lastCreatedPageId}...`, 'info');
      
      const token = getToken();
      if (!token) {
        log('âŒ æœªæ‰¾åˆ°Tokenï¼', 'error');
        return;
      }
      
      try {
        const response = await fetch(`/api/wiki/pages/${lastCreatedPageId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (data.code === 200) {
          log('âœ… åˆ é™¤æˆåŠŸï¼', 'success');
          logBadge('success', 'å·²åˆ é™¤');
          lastCreatedPageId = null;
        } else {
          log(`âŒ åˆ é™¤å¤±è´¥: ${data.msg}`, 'error');
          logBadge('error', `é”™è¯¯ç : ${data.code}`);
        }
      } catch (error) {
        log(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
      }
    }
    
    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥Token
    window.addEventListener('load', () => {
      setTimeout(() => {
        log('ğŸš€ Wiki APIæµ‹è¯•å·¥å…·å·²å°±ç»ª', 'success');
        log('è¯·ç‚¹å‡»"æ£€æŸ¥Token"å¼€å§‹æµ‹è¯•', 'info');
      }, 500);
    });
  </script>
</body>
</html>


