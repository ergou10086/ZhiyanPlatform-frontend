<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§’è‰²æ£€æŸ¥å·¥å…·</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .step {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .step h3 {
            margin-top: 0;
            color: #007bff;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.success {
            background-color: #28a745;
        }
        button.success:hover {
            background-color: #218838;
        }
        button.danger {
            background-color: #dc3545;
        }
        button.danger:hover {
            background-color: #c82333;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 500px;
            overflow-y: auto;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
        }
        .sql-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ç”¨æˆ·è§’è‰²é—®é¢˜æ£€æŸ¥å·¥å…·</h1>
        <p class="subtitle">å¿«é€Ÿè¯Šæ–­å’Œä¿®å¤ç”¨æˆ·è§’è‰²é—®é¢˜</p>
        
        <div class="step">
            <h3>æ­¥éª¤1ï¼šè·å–è®¿é—®ä»¤ç‰Œ</h3>
            <button onclick="getTokenFromStorage()">ä»æœ¬åœ°å­˜å‚¨è·å–Token</button>
            <p style="margin: 10px 0; font-size: 13px; color: #666;">
                Token: <span id="tokenDisplay">æœªè·å–</span>
            </p>
        </div>
        
        <div class="step">
            <h3>æ­¥éª¤2ï¼šæ£€æŸ¥ç³»ç»Ÿè§’è‰²æ˜¯å¦å­˜åœ¨</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
                âš ï¸ å¦‚æœè§’è‰²ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ‰§è¡Œ SQL è„šæœ¬åˆå§‹åŒ–
            </p>
            <div class="sql-box">
                <div style="color: #28a745; font-weight: bold;">æ‰§è¡Œæ­¤SQLåˆå§‹åŒ–è§’è‰²ï¼š</div>
                <pre style="margin: 10px 0;">-- è¿æ¥æ•°æ®åº“
USE zhiyan_userauth_db;

-- åˆ›å»º MEMBER è§’è‰²ï¼ˆæ™®é€šç”¨æˆ·ï¼‰
INSERT INTO roles (id, name, description, role_type, is_system_default, created_at)
VALUES (1, 'MEMBER', 'æ™®é€šç”¨æˆ·', 'SYSTEM', 1, NOW())
ON DUPLICATE KEY UPDATE description = 'æ™®é€šç”¨æˆ·';

-- åˆ›å»º OWNER è§’è‰²ï¼ˆé¡¹ç›®æ‰€æœ‰è€…ï¼‰  
INSERT INTO roles (id, name, description, role_type, is_system_default, created_at)
VALUES (2, 'OWNER', 'é¡¹ç›®æ‰€æœ‰è€…', 'SYSTEM', 1, NOW())
ON DUPLICATE KEY UPDATE description = 'é¡¹ç›®æ‰€æœ‰è€…';

-- ä¸ºæ‰€æœ‰æ²¡æœ‰è§’è‰²çš„ç”¨æˆ·åˆ†é… MEMBER è§’è‰²
INSERT INTO user_roles (user_id, role_id, assigned_at)
SELECT u.id, 1, NOW()
FROM users u
WHERE NOT EXISTS (SELECT 1 FROM user_roles ur WHERE ur.user_id = u.id);</pre>
            </div>
        </div>
        
        <div class="step">
            <h3>æ­¥éª¤3ï¼šéªŒè¯å½“å‰ç”¨æˆ·çš„è§’è‰²</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
                æŸ¥çœ‹å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦æœ‰è§’è‰²åˆ†é…
            </p>
            <button onclick="checkCurrentUserRoles()">æ£€æŸ¥æˆ‘çš„è§’è‰²</button>
        </div>
        
        <div class="step">
            <h3>æ­¥éª¤4ï¼šæµ‹è¯•æ–°ç”¨æˆ·æ³¨å†Œ</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
                æ³¨å†Œä¸€ä¸ªæ–°ç”¨æˆ·ï¼ŒéªŒè¯æ˜¯å¦è‡ªåŠ¨åˆ†é…è§’è‰²
            </p>
            <button class="success" onclick="window.location.href='/register'">å‰å¾€æ³¨å†Œé¡µé¢</button>
        </div>
        
        <div id="result"></div>
    </div>
    
    <script>
        let currentToken = '';
        
        // ä» localStorage è·å– Token
        function getTokenFromStorage() {
            const token = localStorage.getItem('access_token');
            const resultDiv = document.getElementById('result');
            const tokenDisplay = document.getElementById('tokenDisplay');
            
            if (token) {
                currentToken = token;
                tokenDisplay.textContent = token.substring(0, 30) + '...';
                tokenDisplay.style.color = '#28a745';
                resultDiv.className = 'success';
                resultDiv.textContent = 'âœ… æˆåŠŸè·å– Token\n\n' + 
                    'Token: ' + token.substring(0, 50) + '...\n\n' +
                    'ç°åœ¨å¯ä»¥è¿›è¡Œåç»­æ£€æŸ¥äº†ï¼';
            } else {
                resultDiv.className = 'warning';
                resultDiv.textContent = 'âš ï¸ æœªæ‰¾åˆ° Token\n\n' +
                    'è¯·å…ˆç™»å½•ï¼Œæˆ–åœ¨ä¸»åº”ç”¨ä¸­ç™»å½•ååˆ·æ–°æ­¤é¡µé¢';
                tokenDisplay.textContent = 'æœªæ‰¾åˆ°';
                tokenDisplay.style.color = '#dc3545';
            }
        }
        
        // æ£€æŸ¥å½“å‰ç”¨æˆ·çš„è§’è‰²
        async function checkCurrentUserRoles() {
            if (!currentToken) {
                const token = localStorage.getItem('access_token');
                if (token) {
                    currentToken = token;
                } else {
                    alert('è¯·å…ˆè·å–Token');
                    return;
                }
            }
            
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'info';
            resultDiv.textContent = 'â³ æ­£åœ¨æ£€æŸ¥...';
            
            try {
                // é¦–å…ˆè§£æTokenè·å–ç”¨æˆ·ID
                const tokenParts = currentToken.split('.');
                if (tokenParts.length !== 3) {
                    throw new Error('Tokenæ ¼å¼ä¸æ­£ç¡®');
                }
                
                const payload = JSON.parse(atob(tokenParts[1]));
                const userId = payload.userId || payload.user_id || payload.sub;
                
                console.log('Token payload:', payload);
                console.log('User ID:', userId);
                
                if (!userId) {
                    resultDiv.className = 'error';
                    resultDiv.textContent = 'âŒ æ— æ³•ä»Tokenä¸­è·å–ç”¨æˆ·ID\n\n' +
                        'Token payload: ' + JSON.stringify(payload, null, 2);
                    return;
                }
                
                // æŸ¥è¯¢ç”¨æˆ·è§’è‰²
                const response = await fetch(`http://localhost:8091/auth/roles/user/${userId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Accept': 'application/json'
                    },
                    credentials: 'include'
                });
                
                const data = await response.json();
                console.log('è§’è‰²æŸ¥è¯¢å“åº”:', data);
                
                if (response.ok && data.code === 200) {
                    const roles = data.data;
                    if (roles && roles.length > 0) {
                        resultDiv.className = 'success';
                        resultDiv.textContent = 'âœ… å½“å‰ç”¨æˆ·æœ‰è§’è‰²åˆ†é…\n\n' +
                            `ç”¨æˆ·ID: ${userId}\n` +
                            `è§’è‰²: ${Array.isArray(roles) ? roles.join(', ') : JSON.stringify(roles)}\n\n` +
                            'å®Œæ•´å“åº”:\n' + JSON.stringify(data, null, 2);
                    } else {
                        resultDiv.className = 'warning';
                        resultDiv.textContent = 'âš ï¸ å½“å‰ç”¨æˆ·æ²¡æœ‰è§’è‰²åˆ†é…\n\n' +
                            `ç”¨æˆ·ID: ${userId}\n\n` +
                            'è¯·æ‰§è¡Œä¸Šé¢çš„SQLè„šæœ¬ä¸ºç”¨æˆ·åˆ†é…è§’è‰²\n\n' +
                            'å®Œæ•´å“åº”:\n' + JSON.stringify(data, null, 2);
                    }
                } else if (response.status === 403) {
                    resultDiv.className = 'warning';
                    resultDiv.textContent = 'âš ï¸ æƒé™ä¸è¶³ï¼ˆ403ï¼‰\n\n' +
                        'æ­¤æ¥å£éœ€è¦ DEVELOPER è§’è‰²æƒé™\n\n' +
                        'å»ºè®®ï¼šç›´æ¥æ‰§è¡Œä¸Šé¢çš„SQLè„šæœ¬æ£€æŸ¥å’Œåˆ†é…è§’è‰²\n\n' +
                        'æˆ–è€…é€šè¿‡æ•°æ®åº“å®¢æˆ·ç«¯æ‰§è¡Œï¼š\n' +
                        'SELECT * FROM user_roles WHERE user_id = ' + userId + ';';
                } else {
                    resultDiv.className = 'error';
                    resultDiv.textContent = 'âŒ æŸ¥è¯¢å¤±è´¥\n\n' +
                        `çŠ¶æ€ç : ${response.status}\n\n` +
                        'å“åº”:\n' + JSON.stringify(data, null, 2);
                }
            } catch (error) {
                console.error('æ£€æŸ¥é”™è¯¯:', error);
                resultDiv.className = 'error';
                resultDiv.textContent = 'âŒ æ£€æŸ¥å¤±è´¥\n\n' +
                    error.message + '\n\n' +
                    'å»ºè®®ï¼šç›´æ¥åœ¨æ•°æ®åº“ä¸­æ‰§è¡Œä¸Šé¢çš„SQLè„šæœ¬';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶å°è¯•è·å– Token
        window.onload = function() {
            getTokenFromStorage();
        };
    </script>
</body>
</html>

