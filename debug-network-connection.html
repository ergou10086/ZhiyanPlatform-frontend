<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘ç»œè¿æ¥è¯¦ç»†è¯Šæ–­</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 15px;
            border-radius: 5px;
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .error {
            background-color: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        .success {
            background-color: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        .warning {
            background-color: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        .info {
            background-color: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }
        input {
            width: 300px;
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ç½‘ç»œè¿æ¥è¯¦ç»†è¯Šæ–­å·¥å…·</h1>
        
        <div class="test-section">
            <h3>ğŸ“¡ è¿æ¥é…ç½®</h3>
            <p>å½“å‰é…ç½®çš„APIåœ°å€: <span id="currentApiUrl"></span></p>
            <p>å‰ç«¯æœåŠ¡åœ°å€: <span id="frontendUrl"></span></p>
            <button onclick="checkConfiguration()">æ£€æŸ¥é…ç½®</button>
            <div id="configResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸŒ åŸºç¡€ç½‘ç»œæµ‹è¯•</h3>
            <button onclick="testBasicConnectivity()">æµ‹è¯•åŸºç¡€è¿æ¥</button>
            <button onclick="testCorsPreflight()">æµ‹è¯•CORSé¢„æ£€</button>
            <div id="basicResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“§ é‚®ç®±æ£€æŸ¥APIæµ‹è¯•</h3>
            <input type="email" id="testEmail" placeholder="è¾“å…¥æµ‹è¯•é‚®ç®±" value="test@example.com">
            <button onclick="testCheckEmailAPI()">æµ‹è¯•é‚®ç®±æ£€æŸ¥API</button>
            <div id="emailResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“¨ éªŒè¯ç å‘é€APIæµ‹è¯•</h3>
            <button onclick="testSendCodeAPI()">æµ‹è¯•éªŒè¯ç å‘é€API</button>
            <div id="codeResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ” è¯¦ç»†é”™è¯¯åˆ†æ</h3>
            <button onclick="analyzeErrors()">åˆ†æé”™è¯¯</button>
            <div id="errorAnalysis" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“‹ å®æ—¶æ—¥å¿—</h3>
            <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
            <div id="logContainer" class="log-container">
                <div>ç­‰å¾…æµ‹è¯•...</div>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®ä¿¡æ¯
        const configs = {
            direct: 'http://localhost:8091',
            proxy: '', // ä½¿ç”¨ä»£ç†
            production: 'https://your-production-api.com'
        };
        
        let currentConfig = 'proxy'; // é»˜è®¤ä½¿ç”¨ä»£ç†
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push(logEntry);
            
            const logContainer = document.getElementById('logContainer');
            const logDiv = document.createElement('div');
            logDiv.className = type;
            logDiv.textContent = logEntry;
            logContainer.appendChild(logDiv);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            console.log(logEntry);
        }
        
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result ${type}`;
            element.textContent = message;
        }
        
        function clearLogs() {
            logs = [];
            document.getElementById('logContainer').innerHTML = '<div>æ—¥å¿—å·²æ¸…é™¤</div>';
        }
        
        function checkConfiguration() {
            log('å¼€å§‹æ£€æŸ¥é…ç½®...');
            
            const frontendUrl = window.location.origin;
            const apiUrl = configs[currentConfig];
            
            document.getElementById('currentApiUrl').textContent = apiUrl || 'ä½¿ç”¨ä»£ç†';
            document.getElementById('frontendUrl').textContent = frontendUrl;
            
            let configInfo = `é…ç½®æ£€æŸ¥ç»“æœ:\n`;
            configInfo += `å‰ç«¯åœ°å€: ${frontendUrl}\n`;
            configInfo += `APIåœ°å€: ${apiUrl || 'ä½¿ç”¨ä»£ç† (/zhiyan)'}\n`;
            configInfo += `å½“å‰é…ç½®: ${currentConfig}\n`;
            configInfo += `ç”¨æˆ·ä»£ç†: ${navigator.userAgent}\n`;
            configInfo += `é¡µé¢åè®®: ${window.location.protocol}`;
            
            showResult('configResult', configInfo, 'info');
            log('é…ç½®æ£€æŸ¥å®Œæˆ');
        }
        
        async function testBasicConnectivity() {
            log('å¼€å§‹åŸºç¡€è¿æ¥æµ‹è¯•...');
            
            const testUrls = [
                { name: 'ç›´æ¥è¿æ¥', url: configs.direct + '/zhiyan/auth/check-email?email=test@example.com' },
                { name: 'ä»£ç†è¿æ¥', url: '/zhiyan/auth/check-email?email=test@example.com' }
            ];
            
            let results = 'åŸºç¡€è¿æ¥æµ‹è¯•ç»“æœ:\n\n';
            
            for (const test of testUrls) {
                try {
                    log(`æµ‹è¯• ${test.name}: ${test.url}`);
                    
                    const response = await fetch(test.url, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        results += `âœ… ${test.name}: æˆåŠŸ (${response.status})\n`;
                        results += `   å“åº”: ${JSON.stringify(data)}\n\n`;
                        log(`${test.name} æˆåŠŸ: ${response.status}`);
                    } else {
                        results += `âŒ ${test.name}: å¤±è´¥ (${response.status})\n`;
                        results += `   é”™è¯¯: ${response.statusText}\n\n`;
                        log(`${test.name} å¤±è´¥: ${response.status}`);
                    }
                } catch (error) {
                    results += `âŒ ${test.name}: è¿æ¥å¤±è´¥\n`;
                    results += `   é”™è¯¯: ${error.message}\n\n`;
                    log(`${test.name} è¿æ¥å¤±è´¥: ${error.message}`);
                }
            }
            
            showResult('basicResult', results, results.includes('âœ…') ? 'success' : 'error');
            log('åŸºç¡€è¿æ¥æµ‹è¯•å®Œæˆ');
        }
        
        async function testCorsPreflight() {
            log('å¼€å§‹CORSé¢„æ£€æµ‹è¯•...');
            
            try {
                const response = await fetch('/zhiyan/auth/send-verfcode', {
                    method: 'OPTIONS',
                    headers: {
                        'Content-Type': 'application/json',
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });
                
                let result = 'CORSé¢„æ£€æµ‹è¯•ç»“æœ:\n';
                result += `çŠ¶æ€ç : ${response.status}\n`;
                result += `çŠ¶æ€æ–‡æœ¬: ${response.statusText}\n`;
                result += `å…è®¸çš„æ–¹æ³•: ${response.headers.get('Access-Control-Allow-Methods') || 'æœªè®¾ç½®'}\n`;
                result += `å…è®¸çš„å¤´: ${response.headers.get('Access-Control-Allow-Headers') || 'æœªè®¾ç½®'}\n`;
                result += `å…è®¸çš„æ¥æº: ${response.headers.get('Access-Control-Allow-Origin') || 'æœªè®¾ç½®'}\n`;
                
                if (response.ok) {
                    showResult('basicResult', result, 'success');
                    log('CORSé¢„æ£€æˆåŠŸ');
                } else {
                    showResult('basicResult', result, 'warning');
                    log('CORSé¢„æ£€å¤±è´¥');
                }
            } catch (error) {
                const result = `CORSé¢„æ£€å¤±è´¥: ${error.message}`;
                showResult('basicResult', result, 'error');
                log(`CORSé¢„æ£€é”™è¯¯: ${error.message}`);
            }
        }
        
        async function testCheckEmailAPI() {
            const email = document.getElementById('testEmail').value;
            log(`å¼€å§‹æµ‹è¯•é‚®ç®±æ£€æŸ¥API: ${email}`);
            
            try {
                const response = await fetch(`/zhiyan/auth/check-email?email=${encodeURIComponent(email)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                let result = `é‚®ç®±æ£€æŸ¥APIæµ‹è¯•ç»“æœ:\n`;
                result += `é‚®ç®±: ${email}\n`;
                result += `çŠ¶æ€ç : ${response.status}\n`;
                result += `å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}\n`;
                
                if (response.ok) {
                    showResult('emailResult', result, 'success');
                    log('é‚®ç®±æ£€æŸ¥APIæˆåŠŸ');
                } else {
                    showResult('emailResult', result, 'error');
                    log('é‚®ç®±æ£€æŸ¥APIå¤±è´¥');
                }
            } catch (error) {
                const result = `é‚®ç®±æ£€æŸ¥APIå¤±è´¥:\né”™è¯¯: ${error.message}\nç±»å‹: ${error.name}`;
                showResult('emailResult', result, 'error');
                log(`é‚®ç®±æ£€æŸ¥APIé”™è¯¯: ${error.message}`);
            }
        }
        
        async function testSendCodeAPI() {
            const email = document.getElementById('testEmail').value;
            log(`å¼€å§‹æµ‹è¯•éªŒè¯ç å‘é€API: ${email}`);
            
            try {
                const response = await fetch('/zhiyan/auth/send-verfcode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        type: 'REGISTER'
                    })
                });
                
                const data = await response.json();
                
                let result = `éªŒè¯ç å‘é€APIæµ‹è¯•ç»“æœ:\n`;
                result += `é‚®ç®±: ${email}\n`;
                result += `çŠ¶æ€ç : ${response.status}\n`;
                result += `å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}\n`;
                
                if (response.ok) {
                    showResult('codeResult', result, 'success');
                    log('éªŒè¯ç å‘é€APIæˆåŠŸ');
                } else {
                    showResult('codeResult', result, 'error');
                    log('éªŒè¯ç å‘é€APIå¤±è´¥');
                }
            } catch (error) {
                const result = `éªŒè¯ç å‘é€APIå¤±è´¥:\né”™è¯¯: ${error.message}\nç±»å‹: ${error.name}`;
                showResult('codeResult', result, 'error');
                log(`éªŒè¯ç å‘é€APIé”™è¯¯: ${error.message}`);
            }
        }
        
        function analyzeErrors() {
            log('å¼€å§‹é”™è¯¯åˆ†æ...');
            
            let analysis = 'é”™è¯¯åˆ†ææŠ¥å‘Š:\n\n';
            
            // æ£€æŸ¥å¸¸è§é—®é¢˜
            const issues = [];
            
            if (window.location.protocol === 'https:') {
                issues.push('ä½¿ç”¨HTTPSåè®®ï¼Œå¯èƒ½é‡åˆ°æ··åˆå†…å®¹é—®é¢˜');
            }
            
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                issues.push('ä½¿ç”¨æœ¬åœ°åœ°å€ï¼Œæ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨');
            }
            
            if (logs.some(log => log.includes('CORS'))) {
                issues.push('æ£€æµ‹åˆ°CORSé—®é¢˜ï¼Œæ£€æŸ¥åç«¯CORSé…ç½®');
            }
            
            if (logs.some(log => log.includes('NetworkError'))) {
                issues.push('æ£€æµ‹åˆ°ç½‘ç»œé”™è¯¯ï¼Œæ£€æŸ¥ç½‘ç»œè¿æ¥å’Œåç«¯æœåŠ¡');
            }
            
            if (issues.length === 0) {
                analysis += 'âœ… æœªå‘ç°æ˜æ˜¾é—®é¢˜\n';
                analysis += 'å»ºè®®æ£€æŸ¥:\n';
                analysis += '1. åç«¯æœåŠ¡æ˜¯å¦åœ¨ç«¯å£8091è¿è¡Œ\n';
                analysis += '2. å‰ç«¯ä»£ç†é…ç½®æ˜¯å¦æ­£ç¡®\n';
                analysis += '3. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰è¯¦ç»†é”™è¯¯ä¿¡æ¯\n';
            } else {
                analysis += 'å‘ç°ä»¥ä¸‹é—®é¢˜:\n';
                issues.forEach((issue, index) => {
                    analysis += `${index + 1}. ${issue}\n`;
                });
            }
            
            analysis += '\nè§£å†³å»ºè®®:\n';
            analysis += '1. ç¡®ä¿åç«¯æœåŠ¡åœ¨ http://localhost:8091 è¿è¡Œ\n';
            analysis += '2. æ£€æŸ¥å‰ç«¯ä»£ç†é…ç½® (vue.config.js)\n';
            analysis += '3. é‡å¯å‰ç«¯å¼€å‘æœåŠ¡å™¨\n';
            analysis += '4. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜\n';
            analysis += '5. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®\n';
            
            showResult('errorAnalysis', analysis, issues.length > 0 ? 'warning' : 'info');
            log('é”™è¯¯åˆ†æå®Œæˆ');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥é…ç½®
        window.addEventListener('load', function() {
            log('ç½‘ç»œè¯Šæ–­å·¥å…·å·²åŠ è½½');
            checkConfiguration();
        });
    </script>
</body>
</html>
